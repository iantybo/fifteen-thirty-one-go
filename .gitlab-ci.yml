stages:
  - lint
  - test

frontend:eslint:
  stage: lint
  image: node:20
  rules:
    # Run on merge request pipelines when frontend changed
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - frontend/**/*
    # Run on default-branch pipelines when frontend changed (post-merge)
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - frontend/**/*
    - when: never
  variables:
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  cache:
    key: "npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - .npm/
  script:
    - cd frontend
    - npm ci --no-audit --no-fund
    - npm run lint

backend:test:
  stage: test
  image: golang:1.25.5
  rules:
    # Run on merge request pipelines when backend changed
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - backend/**/*
    # Run on default-branch pipelines when backend changed (post-merge)
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - backend/**/*
    - when: never
  variables:
    GOPATH: "$CI_PROJECT_DIR/.go"
  cache:
    key: "go-${CI_COMMIT_REF_SLUG}"
    paths:
      - .go/pkg/mod/
  script:
    - cd backend
    - go mod download
    - go mod verify
    - echo "Checking code formatting..."
    - |
      if [ -n "$(gofmt -l .)" ]; then
        echo "Go code is not formatted:"
        gofmt -d .
        exit 1
      fi
    - echo "Running go vet..."
    - go vet ./...
    - echo "Installing and running staticcheck..."
    - go install honnef.co/go/tools/cmd/staticcheck@latest
    - $GOPATH/bin/staticcheck ./...
    - echo "Installing and running golangci-lint..."
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
    - $GOPATH/bin/golangci-lint run ./...
    - echo "Building project..."
    - go build -v ./...
    - echo "Running tests..."
    - go test -v ./...
    - echo "Running tests with race detector..."
    - go test -race -v ./...
    - echo "Running tests with coverage..."
    - go test -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -func=coverage.out
    - echo "Running vulnerability check..."
    - go install golang.org/x/vuln/cmd/govulncheck@latest
    - $GOPATH/bin/govulncheck ./...
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.out
    paths:
      - backend/coverage.out
    expire_in: 1 week


